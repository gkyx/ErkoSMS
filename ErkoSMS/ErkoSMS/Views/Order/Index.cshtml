@{
    ViewBag.Title = "Satış Yönetimi";
}

@model OrderFilterParameters

@{
    var customers = (List<SelectListItem>)ViewBag.Customers;
}
<div style="margin-top:10px">
    <span class="btn btn-success" id="createSalesButton">
        <span class="fa fa-user-plus"></span> Yeni Satış
    </span>
    <span class="btn btn-success" id="listSalesButton">
        <span class="fa fa-user-plus"></span> Satışları Listele
    </span>
</div>

<div id="listSalesDiv" style="display:none">
    <div id="listSalesButtonDiv" style="margin-top:20px;">
        <input type="button" id="searchButton" value="Filtrele" />
        <input type="button" id="getAllSales" value="Hepsini getir" />
        <hr style="margin: 10px 0;" />
    </div>

    <div id="SalesFilterForm" style="display:none">
        @Html.AntiForgeryToken()
        <div class="row">
            <div class="form-group col-md-6">
                <label>Müşteri:</label>
                @Html.DropDownListFor(x => x.Customers, customers, new { multiple = "multiple", id = "customerdropdown", @class = "chosen-select form-control" })
            </div>
            <div class="form-group col-md-6">
                <label>Satış Durumu:</label>
                @Html.EnumDropDownListFor(x => x.State, new { multiple = "multiple", id = "statedropdown", @class = "chosen-select form-control" })
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-6">
                <label>Kur:</label>
                @Html.EnumDropDownListFor(x => x.Currency, new { multiple = "multiple", id = "currencydropdown", @class = "chosen-select form-control" })
            </div>
            <div class="form-group col-md-6">
                <label>Fatura No:</label>
                @Html.TextBoxFor(x => x.InvoiceNumber, new { @class = "form-control", id = "invoiceTextbox", style = "display:inline-block" })
            </div>
        </div>




        <div>
            <button type="button" id="configurationSaveButton" class="btn btn-primary pull-right">Ara</button>
        </div>
    </div>

    <div style="margin-top: 20px">
        <table id="salesTable" class="table table-bordered table-condensed table-hover table-responsive table-striped"></table>
    </div>
</div>
<div id="createSalesDiv" style="display:none">
    <div class="clearfix">
        <button type="button" id="addOrderLineButton" class="btn btn-primary pull-right">
            <span class="glyphicon glyphicon-plus"></span> Yeni Satır Ekle
        </button>
    </div>
    <div id="products">
    </div>
</div>


<script>
    var tb = $("#salesTable");

    var orderRowTemplate = '@Html.Template("OrderRow", null)';
        $("#addOrderLineButton")
            .on('click',
                function () {
                    var html = $($.parseHTML(orderRowTemplate));
                    html.appendTo($("#products"));
                    $('.stockButton').off().on('click', function (e) {
                        var productCode = e.currentTarget.parentNode.parentNode.querySelector('.productCode').value;
                        ERKOSMS.AjaxAction("Order/GetStockInformationByProductCode?productCode=" + productCode, {}, false).then(function (data) {
            });
    });
                });


    $('#listSalesButton').on('click', function () {
        document.getElementById("listSalesDiv").style.display = "block";
    });

    $('#createSalesButton').on('click', function () {
        document.getElementById("createSalesDiv").style.display = "block";
    });

    $("#getAllSales").on("click",
        function () {
            document.getElementById("SalesFilterForm").style.display = "none";
            destroyTable();
            ERKOSMS.AjaxAction("Order/GetAllSales", {}, false).then(function (data) {
                var datatable = tb.DataTable({
                    autoWidth: true,
                    columns: [
                        { title: "Satış Başlangıç Tarihi", data: "SalesStartDate" },
                        { title: "Fatura Tarihi", data: "InvoiceDate" },
                        { title: "Fatura No", data: "InvoiceNumber" },
                        { title: "Müşteri", data: "Customer.Name" },
                        { title: "Müşteri Ülkesi", data: "Customer.Country" },
                        { title: "Tutar", data: "TotalPrice" },
                        { title: "Kur", data: "Currency" },
                        { title: "Durum", data: "SalesState" }
                    ],
                    data: data,
                    sDom: '<"top"lif<"clear">>rt<"bottom"ip<"clear">>',
                    aaSorting: [], // Initial sorting
                    bInfo: true, // Info is not shown because the total count to show is not known
                    searching: true, // Disable searching TODO: Enable searching if necessary
                    paging: true, // Disable paging in outstanding
                    pageLength: 50,
                    deferRender: true,
                    columnDefs: [
                        {
                            targets: [0, 1],
                            render: formatDate
                        },
                        {
                            targets: [6],
                            render: formatCurrency
                        },
                        {
                            targets: [7],
                            render: formatState
                        }
                    ]
                });
            });
        });

    var formatDate = function (date) {
        if (date == null) {
            return '';
        }
        else {
            return window.moment(date).format("DD-MM-YYYY");
        }

    }

    var formatCurrency = function (data) {
        if (data == 0) {
            return "TL";
        }
        else if (data == 1) {
            return "EUR";
        }
        else if (data == 2) {
            return "USD";
        }
    }

    var formatState = function (data) {
        if (data == -1) {
            return "";
        }
        else if (data == 0) {
            return "İç Satış İletildi";
        }
        else if (data == 1) {
            return "Fatura Kesildi - Yüklendi";
        }
        else if (data == 2) {
            return "Paketleme Bekleniyor";
        }
        else if (data == 3) {
            return "Nakliye Bekleniyor";
        }
        else if (data == 4) {
            return "Ödeme Geldi - Nakliye Bekleniyor";
        }
        else if (data == 5) {
            return "Paketleme Hazır";
        }
        else if (data == 6) {
            return "Paketleme Hazır - Ödeme Bekleniyor";
        }
        else if (data == 7) {
            return "Reddedildi";
        }
        else if (data == 8) {
            return "Cevap Bekleniyor";
        }
    }

    var destroyTable = function () {
        var tb = $("#salesTable");

        if ($.fn.dataTable.isDataTable(tb))
            tb.DataTable().destroy();

        tb.empty();
    };

    $('#configurationSaveButton').on('click', function () {
        document.getElementById("SalesFilterForm").style.display = "none";
        destroyTable();
        debugger;
        var customerIds = $('#customerdropdown').val();
        var states = $('#statedropdown').val();
        var currencies = $('#currencydropdown').val();
        var invoiceNo = $('#invoiceTextbox').val();
        ERKOSMS.AjaxAction("Order/GetFilteredSales", {
            type: 'POST', data: {
                customerIds: customerIds, states: states,
                currencies: currencies, invoiceNo: invoiceNo
            }
        }).then(function (data) {
            debugger;
            var datatable = tb.DataTable({
                autoWidth: true,
                columns: [
                    { title: "Satış Başlangıç Tarihi", data: "SalesStartDate" },
                    { title: "Fatura Tarihi", data: "InvoiceDate" },
                    { title: "Fatura No", data: "InvoiceNumber" },
                    { title: "Müşteri", data: "Customer.Name" },
                    { title: "Müşteri Ülkesi", data: "Customer.Country" },
                    { title: "Tutar", data: "TotalPrice" },
                    { title: "Kur", data: "Currency" },
                    { title: "Durum", data: "SalesState" }
                ],
                data: data,
                sDom: '<"top"lif<"clear">>rt<"bottom"ip<"clear">>',
                aaSorting: [], // Initial sorting
                bInfo: true, // Info is not shown because the total count to show is not known
                searching: true, // Disable searching TODO: Enable searching if necessary
                paging: true, // Disable paging in outstanding
                pageLength: 50,
                deferRender: true,
                columnDefs: [
                    {
                        targets: [0, 1],
                        render: formatDate
                    },
                    {
                        targets: [6],
                        render: formatCurrency
                    },
                    {
                        targets: [7],
                        render: formatState
                    }
                ]
            });
        });
    });

    $('#searchButton').on('click', function () {
        document.getElementById("SalesFilterForm").style.display = "block";
        $('#customerdropdown').select2({ placeholder: "Müşteri Seçin" });
        $('#statedropdown').select2({ placeholder: "Durum Seçin" });
        $('#currencydropdown').select2({ placeholder: "Kur Seçin" });
    });


</script>